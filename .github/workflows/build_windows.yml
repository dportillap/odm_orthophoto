name: Build Windows Exe
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: windows-2019
    
    steps:
    - uses: actions/checkout@v4
    
    # 1. Instalamos Miniforge
    - name: Setup Miniforge
      uses: conda-incubator/setup-miniconda@v3
      with:
        miniforge-variant: Miniforge3
        miniforge-version: latest
        activate-environment: odm_build
        python-version: 3.9
        
    # 2. Instalamos las librerías
    - name: Install Dependencies
      shell: bash -l {0}
      run: |
        mamba install -c conda-forge cmake ninja gdal opencv pcl boost eigen -y
        
    # 3. El Detective Python (Busca las rutas exactas)
    - name: Locate Libraries
      shell: bash -l {0}
      run: |
        python -c "
        import os
        import sys
        
        # Buscamos PCLConfig.cmake recursivamente
        search_root = os.environ['CONDA_PREFIX']
        print(f'Buscando en: {search_root}')
        
        pcl_found = ''
        for root, dirs, files in os.walk(search_root):
            if 'PCLConfig.cmake' in files:
                pcl_found = root.replace(os.sep, '/')
                break
        
        if pcl_found:
            print(f'PCL encontrado en: {pcl_found}')
            # Guardamos la variable para el siguiente paso
            with open(os.environ['GITHUB_ENV'], 'a') as f:
                f.write(f'PCL_DIR_DETECTED={pcl_found}\n')
        else:
            print('ERROR FATAL: No se encontro PCLConfig.cmake')
            sys.exit(1)
        "

    # 4. Compilación con Rutas Absolutas
    - name: Compile
      shell: bash -l {0}
      run: |
        # Generamos el CMakeLists.txt limpio (sin pedir versiones viejas)
        cat > CMakeLists.txt <<EOF
        cmake_minimum_required(VERSION 3.5)
        project(odm_orthophoto)
        set(CMAKE_CXX_STANDARD 14)
        
        find_package(PCL REQUIRED)
        find_package(OpenCV REQUIRED)
        find_package(GDAL REQUIRED)
        find_package(Boost REQUIRED COMPONENTS filesystem system)
        
        include_directories(\${PCL_INCLUDE_DIRS} \${GDAL_INCLUDE_DIRS} \${Boost_INCLUDE_DIRS} \${OpenCV_INCLUDE_DIRS} src)
        add_definitions(\${PCL_DEFINITIONS})
        link_directories(\${PCL_LIBRARY_DIRS})
        
        add_executable(odm_orthophoto src/OdmOrthoPhoto.cpp src/Logger.cpp src/main.cpp)
        target_link_libraries(odm_orthophoto \${OpenCV_LIBS} \${PCL_LIBRARIES} \${GDAL_LIBRARY} \${Boost_LIBRARIES})
        EOF

        mkdir build
        cd build
        
        echo "Usando PCL en: $PCL_DIR_DETECTED"
        
        # Le pasamos a CMake la ruta que encontró Python (-DPCL_DIR=...)
        cmake .. -G "Visual Studio 16 2019" -A x64 \
          -DPCL_DIR="$PCL_DIR_DETECTED" \
          -DCMAKE_PREFIX_PATH="$CONDA_PREFIX/Library" \
          -DCMAKE_BUILD_TYPE=Release
        
        cmake --build . --config Release
        
    # 5. Subimos el artefacto
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: odm_orthophoto_exe
        path: build/Release/odm_orthophoto.exe
        compression-level: 0
