name: Build Windows Exe
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: windows-2019
    
    steps:
    - uses: actions/checkout@v4
    
    # 1. Instalamos Miniforge
    - name: Setup Miniforge
      uses: conda-incubator/setup-miniconda@v3
      with:
        miniforge-variant: Miniforge3
        miniforge-version: latest
        activate-environment: ""
        auto-activate-base: true
        
    # 2. Instalamos librerías
    - name: Install Dependencies
      shell: bash -l {0}
      run: |
        mamba install -n base -c conda-forge cmake ninja compilers gdal opencv pcl boost eigen -y

    # 3. CONSOLIDACIÓN (Compilación)
    - name: Surgical Consolidate
      shell: bash -l {0}
      run: |
        python -c "
        import os, shutil, glob
        if 'CONDA_PREFIX' in os.environ: src_root = os.environ['CONDA_PREFIX']
        else: src_root = 'C:/Users/runneradmin/miniconda3'
        dist_inc = os.path.abspath('MY_LIBS/include')
        dist_lib = os.path.abspath('MY_LIBS/lib')
        if os.path.exists('MY_LIBS'): shutil.rmtree('MY_LIBS')
        os.makedirs(dist_inc)
        os.makedirs(dist_lib)
        
        # Headers Logic
        for root, dirs, files in os.walk(src_root):
            if 'StdVector' in files and root.endswith('Eigen'):
                if not os.path.exists(os.path.join(dist_inc, 'Eigen')): shutil.copytree(root, os.path.join(dist_inc, 'Eigen'))
            if 'pcl_base.h' in files:
                if root.endswith('pcl') and not os.path.exists(os.path.join(dist_inc, 'pcl')): shutil.copytree(root, os.path.join(dist_inc, 'pcl'))
        
        boost_src = os.path.join(src_root, 'Library/include/boost')
        if os.path.exists(boost_src): shutil.copytree(boost_src, os.path.join(dist_inc, 'boost'))
        
        cv = os.path.join(src_root, 'Library/include/opencv2')
        if os.path.exists(cv): shutil.copytree(cv, os.path.join(dist_inc, 'opencv2'))

        root_inc = os.path.join(src_root, 'Library/include')
        if os.path.exists(root_inc):
            for f in os.listdir(root_inc):
                if f.endswith('.h'): shutil.copy2(os.path.join(root_inc, f), os.path.join(dist_inc, f))

        # Libs Logic
        for root, dirs, files in os.walk(src_root):
            for f in files:
                if f.endswith('.lib'):
                    if any(x in f for x in ['pcl_', 'opencv_', 'boost_', 'gdal']):
                        try: shutil.copy2(os.path.join(root, f), os.path.join(dist_lib, f))
                        except: pass

        # Patch Code
        if os.path.exists('src/OdmOrthoPhoto.cpp'):
            with open('src/OdmOrthoPhoto.cpp', 'r') as f: content = f.read()
            if '#include <boost/algorithm/string.hpp>' not in content:
                includes = '#include <boost/algorithm/string.hpp>\n#include <boost/lexical_cast.hpp>\n#include <boost/filesystem.hpp>\n'
                with open('src/OdmOrthoPhoto.cpp', 'w') as f: f.write(includes + content)

        # CMakeLists
        inc_str = dist_inc.replace(os.sep, '/')
        lib_str = dist_lib.replace(os.sep, '/') + '/*.lib'
        var_start = '$' + '{ALL_LIBS}'
        cmake_txt = f'''
        cmake_minimum_required(VERSION 3.5)
        project(odm_orthophoto)
        set(CMAKE_CXX_STANDARD 14)
        add_definitions(-D_CRT_SECURE_NO_WARNINGS -DNOMINMAX -DBOOST_USE_WINDOWS_H)
        include_directories(\"{inc_str}\")
        include_directories(\"src\")
        file(GLOB ALL_LIBS \"{lib_str}\")
        add_executable(odm_orthophoto src/OdmOrthoPhoto.cpp src/Logger.cpp src/main.cpp)
        target_link_libraries(odm_orthophoto {var_start})
        '''
        with open('CMakeLists.txt', 'w') as f: f.write(cmake_txt)
        "

    # 4. COMPILACIÓN
    - name: Compile
      shell: bash -l {0}
      run: |
        mkdir build
        cd build
        cmake .. -G "Visual Studio 16 2019" -A x64 -DCMAKE_BUILD_TYPE=Release
        cmake --build . --config Release

    # 5. EMPAQUETADO DE DLLs (INCLUYE CRYPTO/SSL)
    - name: Deep Bundle DLLs
      shell: bash -l {0}
      run: |
        python -c "
        import os
        import shutil
        
        if 'CONDA_PREFIX' in os.environ: src_root = os.environ['CONDA_PREFIX']
        else: src_root = 'C:/Users/runneradmin/miniconda3'
            
        exe_dir = 'build/Release'
        print(f'Buscando DLLs recursivamente en: {src_root}')
        
        # LISTA EXTENDIDA PARA CUBRIR DEPENDENCIAS DE OPENSSL
        dll_keywords = [
            'pcl', 'boost', 'gdal', 'opencv', 'tbb', 
            'zlib', 'jpeg', 'tiff', 'geos', 'proj',
            'archive', 'bz2', 'lzma', 'iconv', 'zstd', 'xml',
            'crypto', 'ssl', 'curl'  # <-- LOS NUEVOS INVITADOS
        ]
        
        count = 0
        copied_files = set()
        
        for root, dirs, files in os.walk(src_root):
            for f in files:
                if f.endswith('.dll'):
                    if any(k in f.lower() for k in dll_keywords):
                        if f not in copied_files:
                            try:
                                shutil.copy2(os.path.join(root, f), exe_dir)
                                print(f'DLL encontrada y copiada: {f}')
                                copied_files.add(f)
                                count += 1
                            except: pass
        print(f'--> Total DLLs empaquetadas: {count}')
        "
        
    # 6. Subida
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: odm_orthophoto_full_pack_v5
        path: build/Release/
        compression-level: 0
