name: Build Windows Exe
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: windows-2019
    
    steps:
    - uses: actions/checkout@v4
    
    # 1. Instalamos Miniforge
    - name: Setup Miniforge
      uses: conda-incubator/setup-miniconda@v3
      with:
        miniforge-variant: Miniforge3
        miniforge-version: latest
        activate-environment: odm_build
        python-version: 3.9
        
    # 2. Instalación por partes (Divide y Vencerás)
    - name: Install Dependencies
      shell: bash -l {0}
      run: |
        # Instalamos herramientas base
        mamba install -c conda-forge cmake ninja compilers -y
        # Instalamos librerías pesadas por separado para evitar conflictos
        mamba install -c conda-forge gdal opencv boost eigen -y
        # Instalamos PCL forzando reinstalación
        mamba install -c conda-forge pcl --force-reinstall -y
        
        echo "--- Verificando instalación ---"
        mamba list pcl
        
    # 3. Compilación con Lógica de Rescate
    - name: Compile
      shell: bash -l {0}
      run: |
        echo "--- BUSCANDO PCL MANUALMENTE ---"
        # Usamos el comando nativo 'find' de Unix (disponible en Git Bash) para buscar en todo el entorno
        PCL_CONFIG=$(find "$CONDA_PREFIX" -name "PCLConfig.cmake" -o -name "pcl-config.cmake" | head -n 1)
        
        if [ -z "$PCL_CONFIG" ]; then
            echo "ADVERTENCIA: No se encontró PCLConfig.cmake. Activando MODO MANUAL."
            PCL_FOUND_DIR="$CONDA_PREFIX/Library/cmake/pcl-1.12" # Intento de adivinanza
            # Si falla la búsqueda, definimos las rutas a la fuerza en el CMakeLists
            MANUAL_PCL_FLAGS="TRUE"
        else
            echo "¡ENCONTRADO! $PCL_CONFIG"
            PCL_FOUND_DIR=$(dirname "$PCL_CONFIG")
            MANUAL_PCL_FLAGS="FALSE"
        fi

        # --- GENERAMOS EL CMAKELISTS.TXT ---
        cat > CMakeLists.txt <<EOF
        cmake_minimum_required(VERSION 3.5)
        project(odm_orthophoto)
        set(CMAKE_CXX_STANDARD 14)
        
        # Si no encontramos el config, definimos las librerías a mano
        if($MANUAL_PCL_FLAGS)
            message(STATUS "MODO MANUAL: Definiendo rutas de PCL a mano")
            set(PCL_INCLUDE_DIRS "\$ENV{CONDA_PREFIX}/Library/include/pcl-1.14" "\$ENV{CONDA_PREFIX}/Library/include/eigen3")
            set(PCL_LIBRARY_DIRS "\$ENV{CONDA_PREFIX}/Library/lib")
            set(PCL_DEFINITIONS "-D_CRT_SECURE_NO_WARNINGS")
            # Lista de librerías comunes de PCL
            file(GLOB PCL_LIBRARIES "\$ENV{CONDA_PREFIX}/Library/lib/pcl_*.lib")
        else()
            find_package(PCL REQUIRED)
        endif()

        find_package(OpenCV REQUIRED)
        find_package(GDAL REQUIRED)
        find_package(Boost REQUIRED COMPONENTS filesystem system)
        
        include_directories(\${PCL_INCLUDE_DIRS} \${GDAL_INCLUDE_DIRS} \${Boost_INCLUDE_DIRS} \${OpenCV_INCLUDE_DIRS} src)
        add_definitions(\${PCL_DEFINITIONS})
        link_directories(\${PCL_LIBRARY_DIRS})
        
        add_executable(odm_orthophoto src/OdmOrthoPhoto.cpp src/Logger.cpp src/main.cpp)
        
        # Enlazamos todo
        target_link_libraries(odm_orthophoto \${OpenCV_LIBS} \${PCL_LIBRARIES} \${GDAL_LIBRARY} \${Boost_LIBRARIES})
        EOF
        
        mkdir build
        cd build
        
        # Intentamos compilar apuntando a la carpeta encontrada (si existe)
        cmake .. -G "Visual Studio 16 2019" -A x64 \
          -DPCL_DIR="$PCL_FOUND_DIR" \
          -DCMAKE_PREFIX_PATH="$CONDA_PREFIX/Library" \
          -DCMAKE_BUILD_TYPE=Release
        
        cmake --build . --config Release
        
    # 4. Subida del Artefacto
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: odm_orthophoto_exe
        path: build/Release/odm_orthophoto.exe
        compression-level: 0
