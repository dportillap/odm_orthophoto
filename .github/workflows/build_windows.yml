name: Build Windows Exe
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: windows-2019
    
    steps:
    - uses: actions/checkout@v4
    
    # 1. Instalamos Miniforge
    - name: Setup Miniforge
      uses: conda-incubator/setup-miniconda@v3
      with:
        miniforge-variant: Miniforge3
        miniforge-version: latest
        activate-environment: odm_build
        python-version: 3.9
        
    # 2. Instalamos librerías
    - name: Install Dependencies
      shell: bash -l {0}
      run: |
        mamba install -c conda-forge cmake ninja compilers gdal opencv pcl boost eigen -y

    # 3. EL EXPLORADOR: Encontrar las rutas reales (CORREGIDO)
    - name: Find Paths with Python
      shell: bash -l {0}
      run: |
        python -c "
        import os
        import glob
        
        # CORRECCIÓN AQUÍ: Usamos doble backslash para escapar correctamente
        prefix = os.environ['CONDA_PREFIX'].replace('\\\\', '/')
        library_inc = f'{prefix}/Library/include'
        library_lib = f'{prefix}/Library/lib'
        
        print(f'Explorando headers en: {library_inc}')
        
        # 1. Buscar carpeta de version de PCL (ej: pcl-1.14)
        if os.path.exists(library_inc):
            pcl_dirs = [d for d in os.listdir(library_inc) if d.startswith('pcl-') and os.path.isdir(os.path.join(library_inc, d))]
        else:
            pcl_dirs = []

        if pcl_dirs:
            pcl_inc_path = f'{library_inc}/{pcl_dirs[0]}'
            print(f'DETECTADO PCL INCLUDE: {pcl_inc_path}')
        else:
            print('ADVERTENCIA: No se vio carpeta pcl-X.X, usando raiz')
            pcl_inc_path = library_inc

        # 2. Buscar ruta de Eigen
        eigen_path = f'{library_inc}/eigen3'
        
        # 3. Guardar en variables de entorno para el siguiente paso
        with open(os.environ['GITHUB_ENV'], 'a') as f:
            f.write(f'REAL_PCL_INCLUDE={pcl_inc_path}\n')
            f.write(f'REAL_EIGEN_INCLUDE={eigen_path}\n')
            f.write(f'REAL_LIB_PATH={library_lib}\n')
        "

    # 4. COMPILACIÓN CON RUTAS EXACTAS
    - name: Compile
      shell: bash -l {0}
      run: |
        echo "Usando PCL Include: $REAL_PCL_INCLUDE"
        
        # --- GENERAMOS EL CMAKELISTS.TXT ---
        cat > CMakeLists.txt <<EOF
        cmake_minimum_required(VERSION 3.5)
        project(odm_orthophoto)
        set(CMAKE_CXX_STANDARD 14)
        
        add_definitions(-D_CRT_SECURE_NO_WARNINGS -DNOMINMAX -DBOOST_USE_WINDOWS_H)

        # 1. HEADERS
        include_directories("$REAL_PCL_INCLUDE")
        include_directories("$REAL_EIGEN_INCLUDE")
        include_directories("\$ENV{CONDA_PREFIX}/Library/include")
        include_directories("src")
        
        # 2. LIBRERIAS (.LIB)
        link_directories("$REAL_LIB_PATH")
        
        file(GLOB PCL_LIBS "$REAL_LIB_PATH/pcl_*.lib")
        file(GLOB CV_LIBS "$REAL_LIB_PATH/opencv_*.lib")
        file(GLOB BOOST_LIBS "$REAL_LIB_PATH/boost_*.lib")
        set(GDAL_LIB "$REAL_LIB_PATH/gdal_i.lib")
        
        message(STATUS "Ruta de librerias: $REAL_LIB_PATH")
        message(STATUS "PCL Libs found: \${PCL_LIBS}")

        add_executable(odm_orthophoto src/OdmOrthoPhoto.cpp src/Logger.cpp src/main.cpp)
        
        target_link_libraries(odm_orthophoto \${PCL_LIBS} \${CV_LIBS} \${GDAL_LIB} \${BOOST_LIBS})
        EOF
        
        # --- COMPILACIÓN ---
        mkdir build
        cd build
        
        cmake .. -G "Visual Studio 16 2019" -A x64 -DCMAKE_BUILD_TYPE=Release
        cmake --build . --config Release
        
    # 5. Subida
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: odm_orthophoto_exe
        path: build/Release/odm_orthophoto.exe
        compression-level: 0
