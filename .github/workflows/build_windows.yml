name: Build Windows Exe
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: windows-2019
    
    steps:
    - uses: actions/checkout@v4
    
    # 1. Instalamos Miniforge
    - name: Setup Miniforge
      uses: conda-incubator/setup-miniconda@v3
      with:
        miniforge-variant: Miniforge3
        miniforge-version: latest
        activate-environment: odm_build
        python-version: 3.9
        
    # 2. Instalamos librerías
    - name: Install Dependencies
      shell: bash -l {0}
      run: |
        mamba install -c conda-forge cmake ninja compilers gdal opencv pcl boost eigen -y

    # 3. REESTRUCTURACIÓN DE CARPETAS (FLATTENING)
    # Movemos las carpetas anidadas a la superficie para que el compilador las vea fácil.
    - name: Flatten Includes
      shell: bash -l {0}
      run: |
        python -c "
        import os
        import shutil
        import glob
        
        base_dir = os.environ['CONDA_PREFIX'].replace('\\\\', '/')
        inc_dir = f'{base_dir}/Library/include'
        
        print(f'Reorganizando carpetas en: {inc_dir}')
        
        # --- ARREGLAR EIGEN ---
        # Eigen suele instalarse en 'include/eigen3/Eigen'
        # Lo queremos en 'include/Eigen'
        eigen3_dir = f'{inc_dir}/eigen3'
        target_eigen = f'{inc_dir}/Eigen'
        
        if os.path.exists(eigen3_dir) and not os.path.exists(target_eigen):
            # Buscamos la carpeta 'Eigen' dentro de 'eigen3'
            inner_eigen = f'{eigen3_dir}/Eigen'
            if os.path.exists(inner_eigen):
                print(f'Moviendo {inner_eigen} a {target_eigen}')
                shutil.move(inner_eigen, target_eigen)
            else:
                # A veces eigen3 ya contiene los archivos sueltos, copiamos todo
                print('Copiando contenido de eigen3 a raiz...')
                shutil.copytree(eigen3_dir, target_eigen)
        
        # --- ARREGLAR PCL ---
        # PCL suele instalarse en 'include/pcl-1.X/pcl'
        # Lo queremos en 'include/pcl'
        # Buscamos cualquier carpeta que empiece por pcl-1.
        pcl_versioned_dirs = glob.glob(f'{inc_dir}/pcl-*')
        target_pcl = f'{inc_dir}/pcl'
        
        if pcl_versioned_dirs and not os.path.exists(target_pcl):
            # Tomamos la primera que encontramos (ej: pcl-1.12)
            src_pcl = f'{pcl_versioned_dirs[0]}/pcl'
            if os.path.exists(src_pcl):
                 print(f'Moviendo {src_pcl} a {target_pcl}')
                 shutil.move(src_pcl, target_pcl)
        
        print('--- Estructura final de include (primer nivel) ---')
        print(os.listdir(inc_dir))
        "

    # 4. GENERAR CMAKELISTS Y COMPILAR
    - name: Compile
      shell: bash -l {0}
      run: |
        # Usamos Python para buscar las librerías .lib (eso funcionaba bien)
        python -c "
        import os
        import glob
        
        base_dir = os.environ['CONDA_PREFIX'].replace('\\\\', '/')
        lib_dir = f'{base_dir}/Library/lib'
        
        # Buscamos librerías
        all_libs = []
        all_libs.extend(glob.glob(f'{lib_dir}/pcl_*.lib'))
        all_libs.extend(glob.glob(f'{lib_dir}/opencv_*.lib'))
        all_libs.extend(glob.glob(f'{lib_dir}/boost_*.lib'))
        if os.path.exists(f'{lib_dir}/gdal_i.lib'):
            all_libs.append(f'{lib_dir}/gdal_i.lib')
            
        # Normalizamos
        libs_str = ' '.join([f'\"{l.replace(os.sep, forward_slash)}\"' for l in all_libs]).replace('forward_slash', '/')
        
        # Escribimos CMakeLists.txt
        # NOTA: Ahora solo necesitamos incluir 'Library/include' porque ya movimos todo ahí.
        cmake_content = f'''
        cmake_minimum_required(VERSION 3.5)
        project(odm_orthophoto)
        set(CMAKE_CXX_STANDARD 14)
        add_definitions(-D_CRT_SECURE_NO_WARNINGS -DNOMINMAX -DBOOST_USE_WINDOWS_H)
        
        # INCLUDES SIMPLIFICADOS
        include_directories(\"{base_dir}/Library/include\")
        include_directories(\"src\")
        
        add_executable(odm_orthophoto src/OdmOrthoPhoto.cpp src/Logger.cpp src/main.cpp)
        
        target_link_libraries(odm_orthophoto {libs_str})
        '''
        
        with open('CMakeLists.txt', 'w') as f:
            f.write(cmake_content)
        "
        
        mkdir build
        cd build
        cmake .. -G "Visual Studio 16 2019" -A x64 -DCMAKE_BUILD_TYPE=Release
        cmake --build . --config Release
        
    # 5. Subida
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: odm_orthophoto_exe
        path: build/Release/odm_orthophoto.exe
        compression-level: 0
