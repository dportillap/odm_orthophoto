name: Build Windows Exe
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: windows-2019
    
    steps:
    - uses: actions/checkout@v4
    
    # 1. Instalamos Miniforge
    - name: Setup Miniforge
      uses: conda-incubator/setup-miniconda@v3
      with:
        miniforge-variant: Miniforge3
        miniforge-version: latest
        activate-environment: odm_build
        python-version: 3.9
        
    # 2. Instalamos librerías
    - name: Install Dependencies
      shell: bash -l {0}
      run: |
        mamba install -c conda-forge cmake ninja compilers gdal opencv pcl boost eigen -y

    # 3. COMPILACIÓN NUCLEAR (Manual Linking)
    - name: Compile
      shell: bash -l {0}
      run: |
        # Usamos Python para encontrar la versión exacta de la carpeta de PCL (ej: pcl-1.14)
        # Esto es necesario porque el nombre de la carpeta cambia con la versión.
        PCL_VERSION_DIR=$(python -c "import os; print([d for d in os.listdir(os.environ['CONDA_PREFIX']+'/Library/include') if d.startswith('pcl-')][0])")
        echo "Versión de PCL detectada: $PCL_VERSION_DIR"
        
        # --- GENERAMOS UN CMAKELISTS.TXT QUE NO USA FIND_PACKAGE ---
        cat > CMakeLists.txt <<EOF
        cmake_minimum_required(VERSION 3.5)
        project(odm_orthophoto)
        set(CMAKE_CXX_STANDARD 14)
        
        # 1. DEFINIMOS RUTAS DE INCLUSIÓN (HEADERS) A LA FUERZA
        # Usamos variables de entorno que sabemos que existen en Conda
        include_directories("\$ENV{CONDA_PREFIX}/Library/include")
        include_directories("\$ENV{CONDA_PREFIX}/Library/include/eigen3")
        include_directories("\$ENV{CONDA_PREFIX}/Library/include/$PCL_VERSION_DIR")
        include_directories("src")
        
        # 2. AGARRAMOS LAS LIBRERÍAS (.LIB) FÍSICAMENTE
        # En lugar de buscar configs, le decimos: "Usa todo lo que encuentres aquí"
        
        # PCL Libs
        file(GLOB PCL_LIBS "\$ENV{CONDA_PREFIX}/Library/lib/pcl_*.lib")
        
        # OpenCV Libs
        file(GLOB CV_LIBS "\$ENV{CONDA_PREFIX}/Library/lib/opencv_*.lib")
        
        # GDAL Lib
        set(GDAL_LIB "\$ENV{CONDA_PREFIX}/Library/lib/gdal_i.lib")
        
        # Boost Libs
        file(GLOB BOOST_LIBS "\$ENV{CONDA_PREFIX}/Library/lib/boost_*.lib")

        # 3. DEFINICIONES DE PREPROCESADOR
        add_definitions(-D_CRT_SECURE_NO_WARNINGS -DNOMINMAX)
        add_definitions(-DBOOST_USE_WINDOWS_H)
        
        # 4. CREAMOS EL EJECUTABLE
        add_executable(odm_orthophoto src/OdmOrthoPhoto.cpp src/Logger.cpp src/main.cpp)
        
        # 5. ENLAZAMOS TODO LO QUE ENCONTRAMOS
        target_link_libraries(odm_orthophoto \${PCL_LIBS} \${CV_LIBS} \${GDAL_LIB} \${BOOST_LIBS})
        EOF
        
        # --- VERIFICACIÓN (DEBUG) ---
        echo "Archivo CMakeLists.txt generado:"
        cat CMakeLists.txt
        
        # --- COMPILACIÓN ---
        mkdir build
        cd build
        
        cmake .. -G "Visual Studio 16 2019" -A x64 -DCMAKE_BUILD_TYPE=Release
        cmake --build . --config Release
        
    # 4. Subida
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: odm_orthophoto_exe
        path: build/Release/odm_orthophoto.exe
        compression-level: 0
